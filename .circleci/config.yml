version: 2.1

jobs:
  build:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - run:
          name: Set Timezone Automatically
          command: |
            echo "tzdata tzdata/Areas select America" | debconf-set-selections
            echo "tzdata tzdata/Zones/America select Bogota" | debconf-set-selections
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y tzdata
      - run:
          name: Install Dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y bash bats git
      - run:
          name: Create Bash Script
          command: |
            echo "#!/bin/bash" > script.sh
            echo "echo \"Sum: $(expr 2 + 3)\"" >> script.sh
            chmod +x script.sh
      - persist_to_workspace:
          root: .
          paths:
            - script.sh

  test:
    docker:
      - image: ubuntu:latest
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Set Timezone Automatically
          command: |
            echo "tzdata tzdata/Areas select America" | debconf-set-selections
            echo "tzdata tzdata/Zones/America select Bogota" | debconf-set-selections
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y tzdata
      - run:
          name: Install Dependencies
          command: |
            export DEBIAN_FRONTEND=noninteractive
            apt-get update && apt-get install -y bash bats git
      - run:
          name: Create and Run Test
          command: |
            echo "#!/usr/bin/env bats" > test_script.bats
            echo "@test 'Check sum' {" >> test_script.bats
            echo "  result=\$(bash script.sh)" >> test_script.bats
            echo "  [ \"\$result\" = 'Sum: 5' ]" >> test_script.bats
            echo "}" >> test_script.bats
            chmod +x test_script.bats
            bats test_script.bats

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
